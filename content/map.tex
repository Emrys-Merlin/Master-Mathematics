\section{The boundary map}
\label{sec:map}

Finally, we can construct the boundary map as in Theorem~\ref{thm:4.1}. This process will take the whole chapter. The actual construction will be achieved in Section~\ref{sec:construction}. However, we will need the additional assumption that \(H_\mu\) is empty for almost all \(\mu \in \mathcal{P}(\bar X)\) (see Lemma~\ref{lem:H=0}). Afterwards, we will prove that the boundary map (if it exists) will only take values in the Roller boundary \(\partial X\) instead of in the whole Roller compactification \(\bar X\). Then we will have to prove that \(H_\mu\) is indeed empty for almost all \(\mu\). Section~\ref{sec:N=finite} will deal with the rather simple case \(0 < |H_\mu| < \infty\). Section~\ref{sec:N=infty} will construct the tools to deal with the case \(|H_\mu| = \infty\). This case is the most involved and we will have to split it into further subcases in order to deal with it. The detailed startegies for all the cases can be found at the start of each paragraph. Section~\ref{sec:main-proof} contains the statement (Theorem~\ref{thm:4.1}) and the proof of our main theorem. Additionally, it contains a slight generalization in the form of Corollary~\ref{cor:4.2}.

\subsection{The construction of the boundary map}
\label{sec:construction}
In this section we will construct the actual boundary map first assuming that the set of balanced halfspaces \(H_\mu\) (see Section~\ref{sec:weight}) is empty for almost every regular probability measure \(\mu\) (with respect to the measure mentioned in Corollary~\ref{cor:p(x)}). Then we will prove that its image lies in the Roller boundary \(\partial X\).

\begin{lemma}
  \label{lem:H=0}
  Let \(X\) be a finite-dimensional, locally countable CAT(0) cube complex and \(\Gamma\) a group with an action \(\Gamma \to \Aut(X)\) that is essential and non-elementary. Furthermore, let \((B,\Sigma,\vartheta)\) be a strong \(\Gamma\)-boundary. If \(H_\mu = \varnothing\) for almost all \(\mu \in \mathcal{P}(\bar X)\) with respect to the pushforward measure from \(B\), then there exists a measurable map \(\phi\colon B \to \bar X\) which is \(\Gamma\)-equivariant almost everywhere.
\end{lemma}

\begin{proof}
  By Corollary~\ref{cor:p(x)}, we have a measurable map \(\psi\colon B \to \mathcal{P}(\bar X)\) which is \(\Gamma\)-equivariant almost everywhere. Hence, we only need to find a map from \(\mathcal{P}(\bar X)\) to \(\bar X\). We will first prove that if \(H_\mu = \varnothing\) then \(H_\mu^+\) is an ultrafilter. Indeed, since \(\mathcal{H} = H_\mu^+ \sqcup H_\mu \sqcup H_\mu^-\) and \((H_\mu^+)^\ast = H_\mu^-\) (c.\,f.~Lemma~\ref{lem:4.6}), we have the choice condition. For the consistency condition we only need to know that \(\mathfrak{h} \subset \mathfrak{k}\) implies \(\mathcal{C}(\mathfrak{h}) \subset \mathcal{C}(\mathfrak{k})\) and hence \(\mu(\mathcal{C}(\mathfrak{h}))\leq \mu(\mathcal{C}(\mathfrak{k}))\).

  By assumption, the set \(\mathcal{E} \coloneqq \{\mu \in \mathcal{P}(\bar X) \mid H_\mu = \varnothing\}\) has full measure. Since \(\psi\) is only well-defined up to a null set, we can concatenate it with the map
  \begin{align*}
    \xi\colon \mathcal{E} &\to \bar X,\\
    \mu &\mapsto H_\mu^+.
  \end{align*}
  By Lemma~\ref{lem:measurable-mu} applied to the interval\({(\text{\nfrac 1/2}, 1]}\), this map is measurable and \(\Gamma\)-equivariant almost everywhere.

  All in all we have that \(\xi \circ \psi\) is our desired map \(\phi\).
\end{proof}

We will now prove that any \(\phi\) as above only takes values in \(\partial X\). This will be accomplished with the next lemma.

\begin{lemma}[{\cite[Lemma~4.11]{MR3509968}}]
  \label{lem:4.11}
  Let \(X\) be a finite-dimensional, locally countable CAT(0) cube complex. Let  \(\Gamma\) be a discrete, countable group with an essential and non-elementary action \(\Gamma \to \Aut(X)\), \((B, \nu)\) a Lebesgue space on which \(\Gamma\) acts doubly ergodic with coefficients. If \(\phi\colon B \to \bar X\) is a measurable map which is \(\Gamma\)-equivariant almost everywhere, then \(\phi\) takes values in the non-terminating ultrafilters of \(X\).
\end{lemma}

\begin{proof}
  Consider the map
  \begin{align*}
    B & \to \N \cup \{\infty\},\\
    x & \mapsto |\tau(\phi(x))|,
  \end{align*}
  which is measurable (Lemma~\ref{lem:tau}) and \(\Gamma\)-invariant (\(\tau\) was defined in Defintion~\ref{defin:tau}). By ergodicity it is essentially constant with essential value \(M\). If we show that \(M = 0\), then the image of \(\phi\) essentially contains only non-terminating ultrafilters and we are done.

  For this purpose, let us consider the following map
  \begin{align*}
    B \times B & \to \N \cup \{\infty\},\\
    (x,y) & \mapsto |\tau(\mathcal{H}(\phi(x), \phi(y)))|.
  \end{align*}
  It is measurable as it is a composition of measurable maps (consider Lemma~\ref{lem:measurable-interval}) and \(\Gamma\)-invariant. Again we obtain an essential value \(N\). By Remark~\ref{rem:interval} we have that \(N < \infty\) and hence \(\tau(\mathcal{H}(\phi(x), \phi(y)))\) takes values in \(\operatorname{Pot}_f(\mathcal{H})\). By Corollary~\ref{cor:4.5} this would mean that the action of \(\Gamma\) is inessential, unless \(N = 0\).

  Lastly, we will show that this is incompatible with the case \(M > 0\). Contrarily, assume \(M > 0\), then we could find a \(x_0 \in B\) such that \(|\tau(\phi(x_0))| > 0\) and a set \(B_0 \subset B\) of full measure, such that \(\tau(\mathcal{H}(\phi(x_0), \phi(y))) = \varnothing\) for all \(y \in B_0\). By Lemma~\ref{lem:4.12}, for all \(\mathfrak{h} \in \tau(\phi(x_0))\), we have \(\mathfrak{h} \in \phi(y)\).

  However, by Lemma~\ref{lem:countable-orbit}, \(B_0\) contains a \(\Gamma\)-orbit, i.\,e.\ there exists a \(y \in B_0\) such that \(g\mathfrak{h} \in \phi(y)\) for every \(g \in \Gamma\). Now, \(\Gamma\) acts non-elementary and essential. By Theorem~\ref{thm:cs-flipping}, we find \(g \in \Gamma\) such that \(g\mathfrak{h} \subset \mathfrak{h}^\ast\), but by consistency, we would then have \(\mathfrak{h}^\ast \in \phi(y)\) which is a contradiction to the choice condition of ultrafilters.
\end{proof}

\subsection{The case \(0 < |H_\mu| < \infty\)}
\label{sec:N=finite}

So far we have seen that if \(H_\mu\) is empty for almost all \(\mu\), we find our desired map with all the necessary properties. We will now prove that if \(|H_\mu|\) is finite then it is already 0. So after this section we will be left with the case that \(|H_\mu|\) is infinite. The following two lemmas capture the precise ideas. The main argument in the proof of Lemma~\ref{lem:finite-zero} is Corllary~\ref{cor:4.5}, which gives us a contradiction to the essentiality of the \(\Gamma\)-action.

\begin{lemma}
  \label{lem:h-const}
  The map
  \begin{align*}
    \mathcal{P}(\bar X) &\to \N \cup \{\infty\},\\
    \mu &\mapsto |H_\mu|
  \end{align*}
  is essentially constant.
\end{lemma}

\begin{proof}
  The map is \(\Gamma\)-invariant and measurable as a concatenation of measurable maps (c.f.~Section~\ref{sec:meas-maps}). Since the group action is ergodic with regard to the pushforward measure on \(\mathcal{P}(\bar X)\) from \(B\), we see that the map is essentially constant.
\end{proof}

\begin{lemma}
  \label{lem:finite-zero}
  If \(|H_\mu|\) is essentially constant and not infinite, then \(H_\mu\) is empty for almost all \(\mu \in \mathcal{P}(\bar X)\).
\end{lemma}

\begin{proof}
  We consider the map
  \begin{align*}
    \mathcal{P}(\bar X) & \to \operatorname{Pot}_f(\mathcal{H}),\\
    \mu & \mapsto H_\mu.
  \end{align*}
  This map is measurable and \(\Gamma\)-equivariant. Hence, by Corollary~\ref{cor:4.5}, we know that its image has to be essentially \(\varnothing\) in order for our \(\Gamma\)-action to be essential.
\end{proof}

All in all we see that if we can show that \(|H_\mu|\) is finite for almost all \(\mu \in \mathcal{P}(\bar X)\), we are done. 

\subsection{The case \(|H_\mu| = \infty\)}
\label{sec:N=infty}

This is the most involved case. The following two paragraphs will contain all the technical details in order to exclude it. We will divide this case into two subcases, namely \(|H_\mu \cap H_\nu| = 0\) and \(|H_\mu \cap H_\nu| = \infty\) for almost all \(\mu\) and \(\nu\). The strategy is always to find a contradiction to the essentiality of the group action, the non-elementarity of the group action or to the fact that the complex is finite-dimensional. The central result of Paragraph~\ref{sec:M=0} is Proposition~\ref{prop:4.10}. The central results of Paragraph~\ref{sec:M=infty} are Proposition~\ref{prop:4.21} and Proposition~\ref{prop:f-3.32}. Lemma~\ref{lem:4.18} and Lemma~\ref{lem:strongly-sep} are also used in the main proof, but their complete content is given there.
For the two subcases to make sense, we need the following lemma:

\begin{lemma}
  \label{lem:hh-const}
  The map
  \begin{align*}
    \mathcal{P}(\bar X) \times \mathcal{P}(\bar X) &\to \N \cup \{\infty\},\\
    (\mu, \nu) &\mapsto |H_\mu \cap H_\nu|
  \end{align*}
  is essentially constant.
\end{lemma}

\begin{proof}
  This map is again measurable and \(\Gamma\)-invariant (c.\,f.~Section~\ref{sec:meas-maps}) and hence essentially constant by the doubly ergodic action of \(\Gamma\) on \(\mathcal{P}(\bar X)\).
\end{proof}

\subsubsection{The case \(|H_\mu \cap H_\nu| = 0\)}
\label{sec:M=0}

Here we will prove that \(|H_\mu| = \infty\) and \(|H_\mu \cap H_\nu| = 0\) for almost all \(\mu, \nu \in \mathcal{P}(\bar X)\) cannot happen in our setting. More precisely, we will see that \(X\) cannot be finite-dimensional. The precise statement is captured in the next proposition. It is the only result of this paragraph that will be used in the main proof of the theorem. The remainder of this paragraph is only necessary to understand the proof of this proposition.

Unless noted otherwise, \(X\) is a connected, locally countable, finite-dimensional CAT(0) cube complex and \(\Gamma\) a discrete, countable group.

\begin{prop}[{\cite[Proposition~4.10]{MR3509968}}]
  \label{prop:4.10}
  If for almost all \(\mu, \nu \in \mathcal{P}(\bar X)\) we have all of the following:
  \begin{itemize}
  \item \(|H_\mu| = |H_\nu| = \infty\),
  \item \(H_\mu \cap H_\nu = \varnothing\) and
  \item \(\tau(H_\mu \cap H_\nu^+) = \varnothing\),
  \end{itemize}
  then \(X\) contains cubes of arbitrarily large dimension.
\end{prop}

We will prove this proposition at the end of the paragraph. Our strategy is to construct a directed graph having measures as vertices. The following lemma will then give a condition under which two measures are joined by a (directed) edge. Afterwards, we can use a graph theoretic result (Lemma~\ref{lem:A.8}) showing that we find (finite) sets of pairwise transverse halfspaces with arbitrarily many elements. This leads to the desired cubes in Proposition~\ref{prop:4.10}.


\begin{lemma}
  \label{lem:sep-n}
  Let \(\mu, \nu \in \mathcal{P}(\bar X)\) be two regular probability measures such that \(H_\mu \cap H_\nu = \varnothing\) and such that there exists an infinte descending chain \(\mathfrak{h}_n\in H_\mu^+\) and an infinite descending chain \(\mathfrak{k}_m \in H_\nu^+\). Then there exists \(C \in \N\) such that we have a decomposition
  \[
    \N_C \subset N_1 \sqcup N_j,
  \]
  where \(j \in \{2,3,4\}\) and  we have:
  \begin{align*}
    \N_C & \coloneqq \{(n,m) \in \N^2 \mid n,m \geq C\},\\
    N_1 & \coloneqq \{(n,m) \in \N^2 \mid \mathfrak{h}_n \pitchfork \mathfrak{k}_m\},\\
    N_2 & \coloneqq \{(n,m) \in \N^2 \mid \mathfrak{h}_n^\ast \subset \mathfrak{k}_m\},\\
    N_3 & \coloneqq \{(n,m) \in \N^2 \mid \mathfrak{h}_n \subset \mathfrak{k}_m\},\quad \text{and}\\
    N_4 & \coloneqq \{(n,m) \in \N^2 \mid \mathfrak{h}_n \supset \mathfrak{k}_m\}.
  \end{align*}
\end{lemma}

\begin{proof}
  There is the following decomposition:
  \[
    \N \times \N = N_1 \sqcup N_2 \sqcup N_3 \sqcup N_4.
  \] 
  We will consider different cases, depending on which \(N_j\) are not empty. If at most one of the \(N_j\ (j = 2,3,4)\)  is not empty, we are done. So we deal with the cases where at least two of the sets are non-empty.
  \begin{description}
  \item[Case \(N_2, N_3 \neq \varnothing\):] We can take \((n_3, m_3) \in N_3\) and \((n,m) \in N_2\) and define
    \[
      m' \coloneqq \min\{m, m_3\}.
    \]
    Then we have the following two inclusions
    \begin{align*}
      \mathfrak{h}_{n_3} \subset \mathfrak{k}_{m_3} \subset \mathfrak{k}_{m'} \quad \text{and}\quad \mathfrak{h}_{n}^\ast \subset \mathfrak{k}_m \subset \mathfrak{k}_{m'}.
    \end{align*}
    If we have \(n \geq n_3\), we have \(\mathfrak{h}_n \subset \mathfrak{h}_{n_3} \subset \mathfrak{k}_{m'}\), which is impossible by the second inclusion above. Hence, fixing \(m_3\) we define
    \[
      A \coloneqq \min \{n_3 \in \N \mid (n_3, m_3) \in N_3\}
    \]
    and see that for all \(n \geq A\) and any \(m \in \N\) we have \((n,m) \notin \N_2\) or, in other words, we have
    \[
      \{(n,m) \in N_2 \mid n \geq A_3\} = \varnothing.
    \]
    If \(N_4\) is empty, this is already sufficient to show that \(\N_A = N_1 \sqcup N_3\). The case, when all three are not empty, will be handled below.
  \item[Case \(N_3,N_4 \neq \varnothing\):] Again we take \((n_3, m_3) \in N_3\) and \((n,m) \in N_4\). If \(n \geq n_3\), we have
    \[
      \mathfrak{k}_n \subset \mathfrak{h}_n \subset \mathfrak{h}_{n_3} \subset \mathfrak{k}_{m_3}.
    \]
    This would imply that \(\mathfrak{h}_n \in H_\mu \cap H_\nu\), since it is enclosed in two halfspaces which lie in \(H_\nu\). However, we have \(H_\mu \cap H_\nu = \varnothing\). Hence, we define as before
    \[
      B \coloneqq \min \{n_3 \in \N \mid (n_3, m_3) \in N_3\}
    \]
    and see that if \(n \geq B\), then for any \(m \in \N\) we have \((n,m) \notin N_4\). If \(N_2\) is empty, this implies \(\N_B = N_1 \sqcup N_3\).
  \item[Case \(N_2,N_4 \neq \varnothing\):] This case is analogous to the first except that we flip the roles of \(n\) and \(m\). Hence, we define a constant
    \[
      D \coloneqq \min \{m_4 \mid (n_4, m_4) \in N_4\},
    \]
    where \(n_4 \in \N\) was chosen such that the above set is not empty. If \(m \geq B\) and \(n \in \N\) is arbitrary, we have \((n, m) \notin N_2\). As above, if \(N_3 \) is empty, this is sufficient to show that \(\N_D = N_1 \sqcup N_4\).
  \item[Case \(N_j \neq \varnothing\ \ \forall j \in\{2,3,4\}\):] In this case we can use the constants defined above and set \(C \coloneqq \max \{A,B,D\}\). Then if \((n,m) \in \N_C \setminus N_1\), we have \(m \geq B\) and hence \((n,m) \notin N_2\) and \(n \geq D\) meaning \((n,m) \notin N_4\). All in all this leads to \(\N_C = N_1 \sqcup N_3\).
  \end{description}
\end{proof}

\begin{lemma}[{\cite[Lemma~4.13]{MR3509968}}]
  \label{lem:4.13}
  Let \((\mu_i)_{i \in \N_0}\) be a sequence of probability measures in \(\mathcal{P}(\bar X)\) such that \(H_{\mu_i} \cap H_{\mu_j} = \varnothing\) whenever \(i \neq j\) and such that for each \(i > 0\) there exists an infinite descending chain \(\mathfrak{h}_n^i \in H_{\mu_0}^+ \cap H_{\mu_i}\). Then, (up to switching \(i\) and \(j\)) any pair of measures \(\mu_i\) and \(\mu_j\) satisfies the following condition:

  There exists \(C(i,j) \in \N\) such that for every \(n \geq C(i,j)\) there is an \(M_n \geq C(i,j)\) such that if \(m \geq M_n\), then \(\mathfrak{\hat h}^j_m \pitchfork \mathfrak{\hat h}^i_n\). 
\end{lemma}

\begin{proof}
  We fix two measures and call them \(\mu\) and \(\nu\). Let \(\mathfrak{h}_n \in H_{\mu_0}^+ \cap H_\mu\) and \(\mathfrak{k}_m \in H_{\mu_0}^+ \cap H_\nu\) be the corresponding infinite descending sequences.
  
  By Lemma~\ref{lem:sep-n}, we have \(C \in \N\), \(j \in \{2,3,4\}\) and a decomposition
  \[
    \N_C = N_1 \sqcup N_j.
  \]
  We will consider three cases:
  \begin{description}
  \item[Case \(\N_C = N_1 \sqcup N_3\):] If \(N_3 \neq \varnothing\), we take \((n_0, m_0) \in N_3\) and define
    \begin{align*}
      M = M(n_0)  \coloneqq & \max \{m \in \N \mid (n_0, m) \in N_3\}\\
                      = & \max \{m \in \N \mid \mathfrak{h}_{n_0} \subset \mathfrak{k}_m \subset \mathfrak{k}_{m_0}\}.
    \end{align*}
    \(M\) is well-defined since the maximum is taken over a non-empty set (by choice of \((n_0, m_0)\)) and the set is finite since two nested halfspaces contain only finitely many halfspaces in between (c.\,f.\ Lemma~\ref{lem:finite-interval}).

    We see that if \(m > M\), we have \((n_0, m) \in N_1\), which is what we wanted.
  \item[Case \(\N_C = N_1 \sqcup N_2\):] This case works completely analogous, with \(\mathfrak{h}_{n_0}\) replaced by \(\mathfrak{h}_{n_0}^\ast\).
  \item[Case \(\N_C = N_1 \sqcup N_4\):] If we switch the roles of \(\mathfrak{h}_n\) and \(\mathfrak{k}_m\) the proof goes as above and we are done.
  \end{description}
\end{proof}

\subsubsection*{Preliminaries on directed graphs}
We did not dedicate a whole section to directed graphs as they are only necessary to understand the above mentioned proposition. For the main proof, in depth knowledge of this paragraph is not necessary. We will only need the technical result that every complete directed graph has a subgraph with the same vertex set that is strictly upper triangular (Lemma~\ref{lem:A.8}).

\begin{defin}
  A \emph{directed graph \(\mathcal{G}(V,E)\)} consists of two sets \(V\) and \(E\), its \emph{vertex set} and \emph{edge set} respectively and of two maps \(s, t \colon E \to V\) associating to each edge its source and target vertex respectively. In our case there are no parallel edges allowed (antiparallel edges may occur) and we will not allow loops. This allows us to think of \(E \subset V \times V\) and we will prefer writing \(\overline{vw} \in E\) for two vertices \(v,w \in V\). This has the further advantage of making the maps \(s\) and \(t\) obsolete. We will call \(\mathcal{G}\) \emph{complete} if it is complete as an undirected graph, i.\,e.\ each pair of vertices is joined by a single (undirected) edge. For each \(v \in V\) we will denote by \(o(v)\) the number of \emph{outgoing edges} and by \(i(v)\) the number of \emph{incoming edges}. A complete directed finite graph is \emph{strictly upper triangular} if there exists an enumeration \(V = \{v_1, \dots, v_D\}\), such that for all \(j = 1, \dots, D\) we have
  \begin{align*}
    o(v_j) & = D - j\quad \text{and}\\
    i(v_j) & = j - 1.
  \end{align*}
\end{defin}

\begin{rem}
  The name \enquote{strictly upper triangular} stems from the fact that the transition matrix for the graph with the given enumeration of the vertices is strictly upper triangular.
\end{rem}

\begin{lemma}[{\cite[Lemma~A.6]{MR3509968}}]
  \label{lem:A.6}
  If \(\mathcal{G} \coloneqq \mathcal{G}(V,E)\) is a complete directed finite graph with \(|V| = D\) then there exists \(v \in V\) such that \(o(v) \geq \frac{D-1}{2}\).
\end{lemma}

\begin{proof}
  Since \(\mathcal{G}\) is complete we have \(o(v) + i(v) \geq D - 1\) for every \(v \in V\) and summing over all vertices we obtain
  \[
    \sum_{v \in V} o(v) + i(v) \geq D(D-1).
  \]
  Since all edges that start somewhere have to end somewhere, we have:
  \[
    \sum_{v \in V} o(v) = \sum_{v \in V} i(v),
  \]
  leading to
  \[
    \sum_{v \in V} o(v) \geq \frac{D(D-1)}{2}.
  \]
  If \(o(v)\) were smaller than \(\frac{D-1}{2}\) for each \(v \in V\), we would have that
  \[
    \sum_{v \in V} o(v) < \frac{D(D-1)}{2},
  \]
  which is a contradiction. Hence there exists at least one \(v \in V\) such that \(o(v) \geq \frac{D-1}{2}\).
\end{proof}

\begin{lemma}[{\cite[Lemma~A.8]{MR3509968}}]
  \label{lem:A.8}
  Let \(\mathcal{G} = \mathcal{G}(V,E)\) be a (not necessarily finite) complete, directed graph and \(D \in \N\). If \(|V| \geq 5^D\), there exist \(D\) vertices \(v_1, \dots, v_D\) and a subset \(E_D \subset E\) such that \(\mathcal{G}(\{v_1, \dots, v_D\}, E_D)\) is complete, directed and strictly upper triangular.
\end{lemma}

\begin{proof}
  We will prove this by induction, but need a slightly stronger statement. We will prove:

  Let \(N \in \N\) and \(|V| \geq 5^N\). Then for each \(D \leq N\) there exist \(v_1,\dots, v_D \in V\) and a subset \(E_D \subset E\) such that \(\mathcal{G}(\{v_1, \dots, v_D\}, E_D)\) is complete, directed and strictly upper triangular. Furthermore, for the set
  \[
    V_D \coloneqq \{v \in V \setminus \{v_1, \dots, v_D\} \mid \overline{v_iv} \in E\ \forall i =1,\dots, D\}
  \]
  we have \(|V_D| \geq 5^{N-D}\).

  Observe that it is sufficient to prove this statement for finite graphs. Indeed, for infinite graphs, we can always consider a finite subgraph with sufficiently many vertices. So we will reduce to the finite case.
  \begin{description}
  \item[Base: \(D = 1\):] By Lemma~\ref{lem:A.6} we can find a \(v_1 \in V\) such that
    \[
      o(v_1) \geq \frac{|V| - 1}{2} \geq \frac{V}{5} \geq 5^{n-1}.
    \]
    Then \(\mathcal{G}(\{v_1\}, \varnothing)\) is clearly complete and upper triangular. Furthermore, we have that
    \[
      V_1 = \{v \in V \mid \overline{v_1v} \in E\},
    \]
    since \(\mathcal{G}\) does not contain loops. However, then we have \(|V_1| = o(v_1) \geq 5^{N-1}\) and we are done.
  \item[Inductive step: \(D \to D+1\):] By the induction hypothesis we find \(\{v_1, \dots, v_D\}\) and a subset \(E_D \subset E\) such that \(\mathcal{G}(\{v_1, \dots, v_D\}, E_D)\) is complete and strictly upper triangular and \(|V_D| \geq 5^{N-D}\). We consider the complete graph induced by \(\mathcal{G}\) on the set \(V_D \neq \varnothing\). Again by the Lemma~\ref{lem:A.6}, we find a vertex \(v_{D+1} \in V_D\) such that
    \[
      o(v_{D+1}) \geq \frac{|V_D| -1}{2} \geq \frac{|V_D|}{5} \geq 5^{N - (D+1)}.
    \]
    By construction this vertex is connected via an incoming edge to each of the \(v_i\). If we set
    \[
      E_{D+1} = E_D \cup \{\overline{v_iv_{D+1}} \mid \forall i = 1, \dots, D\},
    \]
    then \(\mathcal{G}(\{v_1, \dots, v_{D+1}\}, E_{D+1})\) is still complete and strictly upper triangular by construction. Additionally, we have
    \[
      V_{D+1} = \{v \in V_D \mid \overline{v_{D+1}v} \in E\}
    \]
    and thus \(|V_{D+1}| = o(v_{D+1}) \geq 5^{N- (D+1)}\) which completes the induction.
  \end{description}
\end{proof}

\begin{proof}[Proof of Proposition~\ref{prop:4.10}]
  Since \(H_\mu \cap H_\nu^+\) has no minimal elements for almost all \(\mu, \nu\), we can find a sequence \((\mu_i)_{i \in I}\) such that \(H_{\mu_0}^+ \cap H_{\mu_i}\) contains an infinite descending chain, which we denote by \((\mathfrak{h}^i_n)_{n \in \N}\). Thus we can apply Lemma~\ref{lem:4.13} and find \(C(i,j) \in \N\) such that for all \(n \geq C(i,j)\) there is an \(M \geq c(i,j)\) such that if \(m > M_n\), we have \(\mathfrak{\hat h}_n^i \pitchfork \mathfrak{\hat h}_m^j\) (after possibly switching \(i\) and \(j\)).

  Using this, we can construct the graph \(\mathcal{G} \coloneqq \mathcal{G}(V,E)\) with \(V \coloneqq \{\mu_i \mid i \in I\}\) and an edge from \(\mu_i\) to \(\mu_j\) if and only if the above mentioned \(C(i,j)\) exists. With this, \(\mathcal{G}\) becomes a directed graph and since the \(C(i,j)\) exists for \((i,j)\) or \((j,i)\) it is complete. Hence, we can apply Lemma~\ref{lem:A.8} using any \(D \in \N\) and find (after relabeling) \(\mu_1, \dots, \mu_D \in V\) such that we find a subset of edges \(E_D\) such that \(\mathcal{G}(V,E_D)\) becomes strictly upper triangular. This implies that for each \(1\leq i < j \leq D\) there exists \(C(i,j)\) without needing to switch \(i\) and \(j\). We set
  \begin{align*}
    C &\coloneqq \max\{C(i,j) \mid 1 \leq i < j \leq D\} \quad \text{and}\\
    M &\coloneqq \max\{M_C(i,j) \mid 1 \leq i < j \leq D\}.
  \end{align*}
  Fixing \(n = C\), for each \(m \geq M\) we have that \(\mathfrak{\hat h}_n^i \pitchfork \mathfrak{\hat h}_m^j\) for each \(1 \leq i < j \leq D\). Fixing \(m\), this leads to a set of \(D\) transverse halfspaces. Since they intersect pairwise,  by Theorem~\ref{thm:common-intersection}, the common intersection is not empty. An element in this intersection is in a cube, which has all these hyperplanes as midcubes. Hence, this cube has at least dimension \(D\). Since \(D\) was chosen arbitrarily, \(X\) contains cubes of arbitrary dimension.
\end{proof}

\subsubsection{The case \(|H_\mu \cap H_\nu| = \infty\)}
\label{sec:M=infty}

Here we will prove that \(|H_\mu| = \infty\) and \(|H_\mu \cap H_\nu| = \infty\) cannot happen in our case. The two main results of the paragraph are stated in the following two propositions.

Unless noted otherwise, \(\Gamma\) is assumed to be a discrete, countable group and \(X\) a connected, locally countable, finite-dimensional CAT(0) cube complex.

% \begin{prop}[{\cite[Proposition~4.17]{MR3509968}}]
%   \label{prop:4.17}
%   Let \(\Gamma \to \Aut(X)\) be an essential action. Let \(\mathcal{H}' \subset \mathcal{H}(X)\) be a \(\Gamma\)-invariant subset of halfspaces and \(X_\alpha \subset X\) a \(\Gamma\)-invariant family (with at least two members) of subcomplexes such that \(\mathcal{\hat H}(X_\alpha) = \mathcal{\hat H}'\). Let \(Y\) be the smallest strongly convex subcomplex containing \(A \coloneqq \cup_\alpha X_\alpha\). Then \(Y = X\) and \(X = X(\mathcal{\hat H}') \times Z\), where \(Z\) is some other CAT(0) cube complex.
% \end{prop}

% We will prove this proposition by finding a decomposition of \(\mathcal{H}\) in two sets of pairwise transverse halfspaces. In the main proof, we will then get a contradiction concerning the essentiality of the \(\Gamma\)-action using Corollary~\ref{cor:f-3.21}.

\begin{prop}[{\cite[Corollary~4.21]{MR3509968}}]
  \label{prop:4.21}
  Let \(X\) be irreducible. Assume that for almost every \(\mu \in \mathcal{P}(\bar X)\), there are no strongly separated pairs in \(H_\mu\). If \(H_\mu \cap H_\nu \neq \varnothing\) for almost every pair \((\mu, \nu)\) then the \(\Gamma\)-action is non-essential or \(\Gamma\) has a fixed point in the visual boundary.
\end{prop}

We will find a contradiction to the Flipping Lemma (Theorem~\ref{thm:cs-flipping}). We will see that if there are no strongly separated halfspaces in every\(H_\mu\), then we can find two halfspaces \(\mathfrak{h}, \mathfrak{k} \in \mathcal{H}\) such that for almost every \(\mu\) and every \(\mathfrak{l} \in H_\mu\) we have
\begin{align}
  \mathfrak{h} \subset \mathfrak{l} \subset \mathfrak{k}.\label{eq:flip}
\end{align}
For the precise statement please see Lemma~\ref{lem:4.20}. Of course, this property prevents the \enquote{flipping} of \(\mathfrak{l}\). The main work lies in establishing Equation~\eqref{eq:flip}.

\begin{prop}[{\cite[Corollary~3.32]{fernós}}]
  \label{prop:f-3.32}
  Assume we have an essential and non-elementary action of \(\Gamma\) on \(X\), and \(\Gamma_0 \leq \Gamma\) of finite index. If \(\mathcal{H}' \subset \mathcal{H}\) is a non-empty sub-pocset such that
  \begin{itemize}
  \item \(\Gamma_0 \cdot \mathcal{H}' = \mathcal{H}'\), and
  \item if \(\mathfrak{h}, \mathfrak{h}' \in \mathcal{H}'\) with \(\mathfrak{h} \subset \mathfrak{h}'\) and \(\mathfrak{k} \in \mathcal{H}\) such that \(\mathfrak{h} \subset \mathfrak{k} \subset \mathfrak{h}'\) then \(\mathfrak{k} \in \mathcal{H}'\),
  \end{itemize}
  then either \(\mathcal{H}' = \mathcal{H}\) or \(X = X' \times X''\) and \(\mathcal{H}'\) is the halfspace structure for \(X'\).
\end{prop}

We will prove this with the help of strongly separated halfspaces. We will first consider the irreducible case and show that then \(\mathcal{H} = \mathcal{H}'\) using an infinite sequence of strongly separated halfspaces in \(\mathcal{H}'\). In the reducible case, we will apply the same reasoning on each irreducible factor separately. This leads to the product decomposition

% \subsubsection*{Towards the proof of Proposition~\ref{prop:4.17}}

% As stated above, we will decompose the pocset of halfspaces \(\mathcal{H}\) into two sets of pairwise transverse halfspaces. This leads to the desired product decomposition. First, we need another definition:

% \begin{defin}
%   Let \(Y \subset X\) be a subcomplex. Then \(Y\) is called \emph{strongly convex}, if for every two vertices in \(Y\) we have that every shortest edge path joining the two also lies completely in \(Y\).
% \end{defin}

% \begin{lemma}[{\cite[Lemma~4.16]{MR3509968}}]
%   \label{lem:4.16}
%   Let \(A \subset X\) be a set consisting of (not necessarily connected) cubes. If \(Y\) is the smallest strongly convex subcomplex of \(X\) containing \(A\), then
%   \[
%     \mathcal{\hat H}(Y) = \mathcal{\hat H}(A) \sqcup \{\mathfrak{\hat h} \in \mathcal{\hat H}(Y) \mid \mathfrak{\hat h} \text{ separates } A \text{ in at least two non-trivial subsets}\}.
%   \]
% \end{lemma}

% \begin{proof}
%   Let \(\mathfrak{\hat h} = (\mathfrak{h}, \mathfrak{h}^\ast) \in \mathcal{\hat H}(Y) \setminus \mathcal{\hat H}(A)\). If \(A\) were in \(\mathfrak{h}\), then any geodesic between two points of \(A\) is also contained in \(\mathfrak{h}\), otherwise the geodesic would cross \(\mathfrak{\hat h}\) twice. Hence, \(Y \subset \mathfrak{h}\), as \(Y\) is the smallest strongly convex subcomplex of \(X\) containing \(A\). However, this is a contradiction to the fact that \(\mathfrak{\hat h} \in \mathcal{\hat H}(Y)\).
% \end{proof}

% \begin{proof}[Proof of Proposition~\ref{prop:4.17}]
%   Let \(v \in Y\). Then either \(v \in A\), which is \(\Gamma\)-invariant, or \(v\) lies on a geodesic joining two vertices of \(A\). Since this geodesic is mapped to another geodesic joining two vertices of \(A\) under \(\Gamma\), we again have that \(v\) stays in \(Y\) under the \(\Gamma\)-action. All in all \(Y\) is a \(\Gamma\)-invariant set. The same is true for \(X \setminus Y\). Furthermore, \(X\) is connected and we can find \(v \in Y\) and \(w \in X \setminus Y\), such that the two are connected by an edge. Let \(\mathfrak{\hat h} = \mathfrak{\hat h}(\overline{vw})\) with \(v \in \mathfrak{h}\) and \(w \in \mathfrak{h}^\ast\). Since \(Y\) is strongly convex, we have that \(Y \subset \mathfrak{h}\). Now, for each \(g \in \Gamma\), we have \(gv \in Y\) and \(gw \in X \setminus Y\). Since \(g\) acts by combinatorial maps, the two vertices are still joined by an edge. However, this means that \(d(\Gamma w, \mathfrak{\hat h}) = 1\), which is a contradiction to the fact that \(\Gamma\) acts essential. Thus \(Y = X\).

%   By Lemma~\ref{lem:4.16}, we know that the hyperplanes \(\mathcal{\hat H}\) of \(X\) decompose as
%   \[
%     \mathcal{\hat H} = \mathcal{\hat H(A)} \sqcup \{\mathfrak{\hat h} \in \mathfrak{\hat H} \mid \exists \alpha, \alpha'\colon \mathfrak{h} \text{ separates } X_\alpha  \text{ from } X_{\alpha'}\}.
%   \]
%   We set \(\mathcal{\hat H'} \coloneqq \mathcal{\hat H}(A)\). Consider any \(\mathfrak{\hat h} \in \mathcal{\hat H'}\) and any \(\mathfrak{\hat k}\) separating \(X_\alpha\) from \(X_{\alpha'}\). We need to show that these hyperplanes are transverse. Since \(\mathfrak{\hat h}\) separates \(X_\alpha\) we can find \(x, x' \in X_\alpha\) such that \(x \in \mathfrak{h}\) and \(x' \in \mathfrak{h}^\ast\). Analogously, we find vertices \(y,y' \in X_{\alpha'}\). Then \(x,x' \in \mathfrak{k}\) and \(y,y' \in \mathfrak{k}^\ast\) (or vice versa) and we have that the four intersections \(\mathfrak{h} \cap \mathfrak{k},\ \mathfrak{h} \cap \mathfrak{k}^\ast,\ \mathfrak{h}^\ast \cap \mathfrak{k}\) and \(\mathfrak{h}^\ast \cap \mathfrak{k}^\ast\) are non-empty. Thus \(\mathcal{H}\) splits in two transverse subsets, and \(X\) splits as the required product.
% \end{proof}

\subsubsection*{Towards the proof of Proposition~\ref{prop:4.21}}

As stated above, we will try to find a contradition to the Flipping Lemma (Theorem~\ref{thm:cs-flipping}). This is done by \enquote{flanking} any element \(\mathfrak{l}\) in \(H_\mu\) by two halfspaces thus preventing it from flipping.

\begin{lemma}[{\cite[Lemma~4.18]{MR3509968}}]
  \label{lem:4.18}
  Let \(X = X_1 \times \dots \times X_n\) be the decomposition of \(X\) into irreducible factors and \(\mathcal{H} = \mathcal{H}_1 \sqcup \dots \sqcup \mathcal{H}_n\) the associated decomposition of halfspaces. If \(H_\mu \cap \mathcal{H}_i\) contains strongly separated halfspaces (c.\,f.~Definition~\ref{defin:strong-sep}) for every \(i\), then \(H_\mu^+\) satisfies the descending chain condition.
\end{lemma}

\begin{proof}
  Let \((\mathfrak{h}_i)_{i \in \N}\) be a descending chain in \(H_\mu^+\). Since all \(\mathfrak{h}_i\) are parallel, they all lie in a commen \(\mathcal{H}_k\). Without loss of generality we assume \(k=1\). Now, take \(\mathfrak{h, k} \in H_\mu \cap \mathcal{H}_1\) with \(\mathfrak{h} \subset \mathfrak{k}\) strongly separated in \(\mathcal{H}_1\) and define
  \[
    P(\mathfrak{h}) \coloneqq \{\mathfrak{l} \in H_\mu^+ \cap \mathcal{H}_1 \mid \mathfrak{h} \parallel \mathfrak{l}\}.
  \]
  Because of the strong separation, each \(\mathfrak{l} \in \mathcal{H}_1\) is parallel to \(\mathfrak{h}\) or \(\mathfrak{k}\). Hence, we have
  \[
    H_\mu^+ \cap \mathcal{H}_1 = P(\mathfrak{h}) \cup P(\mathfrak{k}).
  \]
  We return to our descending chain. By going over to a subsequence, we can assume that all halfspaces lie in either \(P(\mathfrak{h})\) or \(P(\mathfrak{k})\). Without loss of generality, we choose \(P(\mathfrak{h})\). The case \(\mathfrak{h}_n \subset \mathfrak{h}\) and \(\mathfrak{h}_n \subset \mathfrak{h}^\ast\) cannot happen, as \(\mu(\mathfrak{h}) = \mu(\mathfrak{h}^\ast) < \mu(\mathfrak{h}_n)\). In the case that \(\mathfrak{h} \subset \mathfrak{h}_n\), we know by Lemma~\ref{lem:finite-interval} that there are only finitely many halfspaces between the two. Hence, the chain must terminate. The same argument holds in the case \(\mathfrak{h}^\ast \subset \mathfrak{h}_n\).
\end{proof}


\begin{lemma}
  \label{lem:strongly-sep}
  Let \(\mathfrak{h} \subset \mathfrak{k} \subset \mathfrak{l}\) be three halfspaces in \(\mathcal{H}\) and \(g \in \Gamma\). Then
  \begin{enumerate}
  \item if \((\mathfrak{h}, \mathfrak{k})\) or \((\mathfrak{k}, \mathfrak{l})\) are strongly separated, then the same is true for \((\mathfrak{h}, \mathfrak{l})\), and
  \item \((\mathfrak{h}, \mathfrak{k})\) is strongly separated if and only if the same is true for \((g\mathfrak{h}, g\mathfrak{k})\).
  \end{enumerate}
\end{lemma}

\begin{proof}~\vspace{-6pt}
  \begin{enumerate}
  \item Assume that \(\mathfrak{m}\) is transverse to both \(\mathfrak{h}\) and \(\mathfrak{l}\). Then we would have
    \begin{alignat*}{2}
      \mathfrak{m}^{\phantom{\ast}} \cap \mathfrak{k}^{\phantom{\ast}} & \supset \mathfrak{m}^{\phantom{\ast}} \cap \mathfrak{h}^{\phantom{\ast}} &&\neq \varnothing,\\
      \mathfrak{m}^\ast \cap \mathfrak{k}^{\phantom{\ast}}  & \supset \mathfrak{m}^\ast \cap \mathfrak{h}^{\phantom{\ast}} &&\neq \varnothing,\\
      \mathfrak{m}^{\phantom{\ast}} \cap \mathfrak{k}^\ast & \supset \mathfrak{m}^{\phantom{\ast}} \cap \mathfrak{l}^\ast &&\neq \varnothing\quad \text{and}\\
      \mathfrak{m}^\ast \cap \mathfrak{k}^\ast & \supset \mathfrak{m}^\ast \cap \mathfrak{l}^\ast &&\neq \varnothing.
    \end{alignat*}
    Hence, \(\mathfrak{m}\) is transverse to \(\mathfrak{k}\). This contradicts the assumption that \((\mathfrak{h}, \mathfrak{k})\) or \((\mathfrak{k}, \mathfrak{l})\) are strongly separated.
  \item If \((\mathfrak{h}, \mathfrak{k})\) are strongly separated and we have any \(\mathfrak{m} \in \mathcal{H}\), then \(g^{-1}\mathfrak{m} \in \mathcal{H}\) and it is parallel to either \(\mathfrak{h}\) or \(\mathfrak{k}\). Hence, \(\mathfrak{m}\) is parallel to either \(g\mathfrak{h}\) or \(g\mathfrak{k}\). The opposite direction is analogous.
  \end{enumerate}
\end{proof}

\begin{lemma}[{\cite[Lemma~4.19]{MR3509968}}]
  \label{lem:4.19}
  Let \(X\) be irreducible and \(\Gamma \to \Aut(X)\) an essential and non-elementary group action. For every measure \(\mu\) either \(\hat H_\mu\) contains a pair of strongly separated hyperplanes or there exists a pair \(\mathfrak{h} \in H_\mu^-\) and \(\mathfrak{k} \in H_\mu^+\) of halfspaces, such that the hyperplanes \(\mathfrak{\hat h}\) and \(\mathfrak{\hat k}\) are strongly separated and for every \(\mathfrak{l} \in H_\mu\) we have  \(\mathfrak{h} \subset \mathfrak{l} \subset  \mathfrak{k}\) or \(\mathfrak{h} \subset \mathfrak{l}^\ast \subset \mathfrak{k}\)
\end{lemma}

\begin{proof}
  Suppose that \(H_\mu\) does not contain strongly separated halfspaces. By Proposition\ \ref{prop:cs-5.1}, we find two strongly separated halfspaces \(\mathfrak{k}_i\) such that \(\mathfrak{k}_1 \subset \mathfrak{l} \subset \mathfrak{k}_2\). By Lemma~\ref{lem:cs-dsl}, we find \(g \in \Gamma\) such that
  % \[
  %   g\mathfrak{k}_1 \subset g\mathfrak{k}_2 \subset \mathfrak{k}_1 \subset \mathfrak{l} \subset \mathfrak{k}_2 \subset g^{-1}\mathfrak{k}_1 \subset g^{-1} \mathfrak{k}_2.
  % \]
  \begin{center}
    \input{./content/lemma-4-19}
  \end{center}
  The arcs in the diagram connect strongly separated halfspaces which were identified using Lemma~\ref{lem:strongly-sep}.

  We would like to show that \(g\mathfrak{k}_1 \in H_\mu^-\) and \(g^{-1}\mathfrak{k}_2 \in H_\mu^+\). If neither \(\mathfrak{k}_i\) is in \(H_\mu\), we are done (since \(\mathfrak{l}\) is in \(H_\mu\)). Suppose that \(\mathfrak{k}_2\) is in \(H_\mu\), then \(\mathfrak{k}_1 \in H_\mu^-\), because \(H_\mu\) contains no strongly separated halfspaces. Thus by the additivity of the measure we also have \(g\mathfrak{k}_1 \in H_\mu^-\). Additionally, \(g^{-1}\mathfrak{k}_2 \in H_\mu^+\) again since it is strongly separated from \(\mathfrak{k}_2\). The case if \(\mathfrak{k}_1 \in H_\mu\) can be proven similarly.

  There is one additional step necessary. We define \(\mathfrak{h} \coloneqq g^2\mathfrak{k}_1 \in H_\mu^-\) and \(\mathfrak{k} \coloneqq g^{-2}\mathfrak{k}_2 \in H_\mu^+\), which are strongly separated by Lemma~\ref{lem:strongly-sep}. Furthermore, we set \(\mathfrak{k_0} \coloneqq g\mathfrak{k}_1 \in H_\mu^-\) and \(\mathfrak{k}_3 \coloneqq g^{-1}\mathfrak{k}_2\). Then we have the following sequence:
  \[
    \mathfrak{h} \subset \mathfrak{k}_0 \subset \mathfrak{k}_3 \subset \mathfrak{k},
  \]
  where the pairs \((\mathfrak{h}, \mathfrak{k}_0)\), \((\mathfrak{k_0}, \mathfrak{k}_3)\) and \((\mathfrak{h}, \mathfrak{k})\) are strongly separated. 

  If we take any other \(\mathfrak{l}' \in H_\mu\), then \(\mathfrak{k} \not\subset \mathfrak{l}'\) and \(\mathfrak{k} \not \subset \mathfrak{l}'^\ast\), because of the measure. Additionally, \(\mathfrak{l}' \not\pitchfork \mathfrak{k}\), since it would be parallel to \(\mathfrak{k}_3\) and as before we would have \(\mathfrak{k}_3 \not\subset \mathfrak{l}'\) and \(\mathfrak{k}_3 \not\subset \mathfrak{l}'^\ast\). Hence, \(\mathfrak{l}'\) or \(\mathfrak{l}'^\ast\) contains \(\mathfrak{k}_3\) and thus \(\mathfrak{k}\). All in all this shows that either \(\mathfrak{l}'\) or \(\mathfrak{l}'^\ast\) contains \(\mathfrak{k}\). Up to renaming, we can assume that \(\mathfrak{l}' \subset \mathfrak{k}\). A similar argument applied to \(\mathfrak{h}\) and \(\mathfrak{l}'\), shows that \(\mathfrak{h} \subset \mathfrak{l}'\) and hence \(\mathfrak{h} \subset \mathfrak{l}' \subset \mathfrak{k}\).
\end{proof}


\begin{lemma}[{\cite[Lemma~4.20]{MR3509968}}]
  \label{lem:4.20}
  Let \(X\) be irreducible. Let \(\mu_i \in \mathcal{P}(\bar X)\) be a family of measures such that \(\hat H_{\mu_i}\) does not contain strongly separated hyperplanes for all \(i\) and \(H_{\mu_{i_0}} \cap H_{\mu_i} \neq \varnothing\) for all \(i\) and a fixed \(i_0\). Then there exists a pair of halfspaces \(\mathfrak{h} \subset \mathfrak{k}\) such that \(\mathfrak{\hat h}\) and \(\mathfrak{\hat k}\) are strongly separated and for every \(\mathfrak{l} \in H_{\mu_j}\), we have \(\mathfrak{h} \subset \mathfrak{l} \subset \mathfrak{k}\) or \(\mathfrak{h} \subset \mathfrak{l}^\ast \subset \mathfrak{k}\).
\end{lemma}

\begin{proof}
  We fix \(\mu_0\coloneqq \mu_{i_0}\) and apply Lemma~\ref{lem:4.19} to find strongly separated halfspaces \(\mathfrak{h_2} \subset \mathfrak{h_3}\). By Lemma~\ref{lem:cs-dsl}, we find a \(g \in \Gamma\) such that \(g\mathfrak{h}_3 \subset \mathfrak{h}_2 \subset \mathfrak{h}_3\). We set \(\mathfrak{h}_0 \coloneqq g^2 \mathfrak{h}_2\), \(\mathfrak{h}_1 \coloneqq g\mathfrak{k}_2\), \(\mathfrak{h}_4 \coloneqq g^{-1}\mathfrak{h}_3\) and \(\mathfrak{h}_5 \coloneqq g^{-2} \mathfrak{h}_3\). Then we have the sequence
  \[
    \mathfrak{h}_0 \subset \mathfrak{h}_1 \subset \mathfrak{h}_2 \subset \mathfrak{h}_3 \subset \mathfrak{h}_4 \subset \mathfrak{h}_5.
  \]
  Since \(\mathfrak{h}_2\) and \(\mathfrak{h}_3\) are strongly separated, by the Lemma~\ref{lem:strongly-sep} the above halfspaces are pairwise strongly separated.

  We would like to show that \(\mathfrak{h}_0 \subset \mathfrak{l} \subset \mathfrak{h}_5\) for each \(\mathfrak{l} \in H_{\mu_i}\) and every \(i\). This is in fact already true for every \(\mathfrak{l} \in H_{\mu_i} \cap H_{\mu_0}\). By assumption, we know that the intersection is not empty and we fix a \(\mathfrak{l}_i \in H_{\mu_i} \cap H_{\mu_0}\) for every \(i\).

  Now, for every \(\mathfrak{l} \in H_{\mu_i}\), we see that \(\mathfrak{l}\) can be parallel to at most one \(\mathfrak{h}_i\), since they are pairwise strongly separated. We will consider the following cases:
  \begin{description}
  \item[Case 1:] If \(\mathfrak{l}\) is transverse to any \(\mathfrak{h}_i\), where \(1 \leq i \leq 4\), we are done, because in this case \(\mathfrak{l}\) is parallel to \(\mathfrak{h}_0\) and \(\mathfrak{h}_5\).
  \item[Case 2:] Assume that \(\mathfrak{l}\) were transverse to \(\mathfrak{h}_0\). We will see that this is impossible. In this case it is parallel to \(\mathfrak{h}_1\) and we consider the following two subcases:
    \begin{itemize}
    \item We could have the chain \(\mathfrak{l}' \subset \mathfrak{h}_1 \subset \mathfrak{h}_2 \subset \mathfrak{l}_i\), where \(\mathfrak{l}'\) were either \(\mathfrak{l}\) or its complement. In either case, we would have \(\mathfrak{l}', \mathfrak{l}_i \in H_{\mu_i}\) and thus the same were also true for the two enclosed halfspaces. However, \(\mathfrak{h}_1\) and \(\mathfrak{h}_2\) are strongly separated and \(H_{\mu_i}\) does not contain pairs of strongly separated halfspace, so this cannot happen.
    \item The only other possibility is where \(\mathfrak{h}_0 \subset \mathfrak{h}_1 \subset \mathfrak{l}'\), but then \(\mathfrak{h}_0\) cannot be transverse to \(\mathfrak{l}\). 
    \end{itemize}
    Thus \(\mathfrak{l}\) can never be transverse to \(\mathfrak{h}_0\). 
  \item[Case 3:] If \(\mathfrak{l}\) is transverse to \(\mathfrak{h}_5\) we find a contradiction as in Case 2.
  \item[Case 4:] If \(\mathfrak{l}\) is parallel to each \(\mathfrak{h}_i\), then \(\mathfrak{l}' \not\subset \mathfrak{h_0}\), since otherwise \(H_{\mu_i}\) would again contain pairs of strongly separated halfspaces. By the same argument \(\mathfrak{h}_5 \not\subset \mathfrak{l}'\), where \(\mathfrak{l}'\) is defined as above. As before we obtain \(\mathfrak{h}_0 \subset \mathfrak{l} \subset \mathfrak{h}_5\) or \(\mathfrak{h}_0 \subset \mathfrak{l}^\ast \subset \mathfrak{h}_5\).
  \end{description}
\end{proof}

\begin{proof}[Proof of Proposition~\ref{prop:4.21}]
  By the construction of the product measure, we find a measure \(\mu_0\) and a subset \(B_0 \subset \mathcal{P}(\bar X)\) of full measure, such that for all \(\nu \in B_0\), we have
  \[
    H_{\mu_0} \cap H_\nu \neq \varnothing.
  \]
  By Lemma~\ref{lem:4.20}, we find two halfspaces \(\mathfrak{h} \subset \mathfrak{k}\) such that for each hyperplane \(\mathfrak{\hat l} \in \mathcal{\hat H}_\nu\) with \(\nu \in B_0\), we that (after a possible involution of \(\mathfrak{l}\)) \(\mathfrak{h} \subset \mathfrak{l} \subset \mathfrak{k}\).

  Since \(\Gamma\) is countable, we can apply Lemma~\ref{lem:countable-orbit} and find a \(\nu_0 \in B_0\) such that \(\Gamma \nu_0 \subset B_0\). 

  We fix an \(\mathfrak{l} \in H_{\nu_0}\). We know that \(g\nu_0 \in B_0\). Hence, we have \(\mathfrak{h} \subset g\mathfrak{l} \subset \mathfrak{k}\) for all \(g \in \Gamma\). However, then \(\mathfrak{l}^\ast \not \subset g\mathfrak{l}\) for all \(g \in \Gamma\), because \(\mathfrak{k}\) cannot contain both \(\mathfrak{l}\) and \(\mathfrak{l}^\ast\). Theorem~\ref{thm:cs-flipping} then finishes the proof in the irreducible case.
\end{proof}

\subsubsection*{Towards the proof of Proposition~\ref{prop:f-3.32}}

\begin{lemma}[{\cite[Lemma~3.31]{fernós}}]
  \label{lem:f-3.31}
  Suppose that \(X\) is irreducible with a non-elementary and essential action of the group \(\Gamma\). Any non-empty sub-pocset \(\mathcal{H}' \subset  \mathcal{H}\) satisfying the following properties must be equal to \(\mathcal{H}\):
  \begin{itemize}
  \item \(\Gamma \cdot \mathcal{H}' = \mathcal{H}'\), and
  \item if \(\mathfrak{h}, \mathfrak{h}' \in \mathcal{H}'\) with \(\mathfrak{h} \subset \mathfrak{h}'\) and \(\mathfrak{k} \in \mathcal{H}\) such that \(\mathfrak{h} \subset \mathfrak{k} \subset \mathfrak{h}'\) then \(\mathfrak{k} \in \mathcal{H}'\).
  \end{itemize}
\end{lemma}

\begin{proof}
  Let \(\mathfrak{h}_0 \in \mathcal{H}'\). By Proposition, we find \(\mathfrak{k}, \mathfrak{l} \in \mathcal{H}\) such that \(\mathfrak{k}\) and \(\mathfrak{l}\) are strongly separated and we have
  \[
    \mathfrak{k} \subset \mathfrak{h}_0 \subset \mathfrak{l}.
  \]
  By the Double Skewering Lemma (Lemma~\ref{lem:cs-dsl}), we find \(g \in \Gamma\) such that \(g\mathfrak{l} \subsetneq \mathfrak{k}\). By Lemma~\ref{lem:strongly-sep}, \(g\mathfrak{h}_0\) and \(\mathfrak{l}\) are. Then, \(g^2\mathfrak{h}_0\) and \(g\mathfrak{l}\) are strongly separated, too. And lastly, we obtain that \(g^2\mathfrak{h}_0\) and \(\mathfrak{h}_0\) are strongly separated. With this in mind we define the sequence
  \[
    \dots \subset \mathfrak{h}_{-2} \subset \mathfrak{h}_{-1} \subset \mathfrak{h} \subset \mathfrak{h}_1 \subset \mathfrak{h}_2 \subset \dots
  \]
  where \(\mathfrak{h}_{-n} = g^{2n}\mathfrak{h}_0\) and \(\mathfrak{h}_n = g^{-2n}\mathfrak{h}_0\) for each \(n \in \N\). By the previous observations the elements of the sequence are pairwise strongly separated. Additionally, we have \(\mathfrak{h}_i \in \mathcal{H}'\) for every \(i \in \Z\), since \(\mathfrak{H}'\) is \(\Gamma\)-invariant.

  Now, let \(\mathfrak{m} \in \mathcal{H}\) be any halfspace. Then \(\mathfrak{m}\) is transverse to at most one \(\mathfrak{h}_i\). However, this implies that either \(\mathfrak{m}\) or \(\mathfrak{m}^\ast\) is comparable to the other elements of the sequence and hence, we must find \(i \in \Z\) such that \(\mathfrak{h}_n \subset \mathfrak{m}' \subset \mathfrak{h}_{n+1}\) where \(\mathfrak{m}'\) is either \(\mathfrak{m}\) or \(\mathfrak{m}^\ast\). By assumption, \(\mathfrak{m}'\) lies in \(\mathcal{H}'\) and because \(\mathcal{H}'\) is closed under involution the same is true for \(\mathfrak{m}\).
\end{proof}

\begin{proof}[Proof of Proposition~\ref{prop:f-3.32}]
  If \(X\) is irreducible, we can apply Lemma~\ref{lem:f-3.31} and find that \(\mathcal{H} = \mathcal{H}'\). Otherwise, let
  \[
    \mathcal{H} = \mathcal{H}_1 \sqcup \dots \sqcup \mathcal{H}_n
  \]
  the decomposition into sets of pairwise transverse halfspaces corresponding to the irreducible decomposition. By Lemma~\ref{lem:2.28}, we can assume without loss of generality that \(\Gamma_0\) preserves this decomposition. Then we can apply Lemma~\ref{lem:f-3.31} on each of the sets \(\mathcal{H}' \cap \mathcal{H}_i\) considered as subsets of the pocsets \(\mathcal{H}_i\). Then the intersection is either empty, or we have \(\mathcal{H}' \cap \mathcal{H}_i = \mathcal{H}_i\). With this we see that \(X\) decomposes as the desired product.
\end{proof}

\subsection{The main theorem}
\label{sec:main-proof}

Finally, we are in a position to prove our main theorem (Theorem~\ref{thm:4.1}). A slight generalization takes the form of Corollary~\ref{cor:4.2}. The proofs will use all the technical details of the previous sections. Additionally, we will make heavy use of the measurability results of Section~\ref{sec:meas-maps}, results for essential and non-elementary group actions on CAT(0) cube complexes in Section~\ref{sec:special} and results concerning strong \(\Gamma\)-boundaries in the Sections~\ref{sec:ergodic} and~\ref{sec:grp-boundary}.

\begin{thm}[{\cite[Theorem~4.1]{MR3509968}}]
  \label{thm:4.1}
  Let \(\Gamma\) be a discrete, countable group acting on a connected, locally countable, finite-dimensional CAT(0) cube complex \(X\) via automorphisms. Assume the action is essential and non-elementary. If \((B, \Sigma, \vartheta)\) is a strong \(\Gamma\)-boundary, there exists a measurable map
  \[
    \phi\colon B \to \partial X
  \]
  which is \(\Gamma\)-equivariant almost everywhere and which takes values in the non-terminating ultrafilters in \(\partial X\).
\end{thm}

\begin{proof}
  By Lemma~\ref{lem:h-const}, \(|H_\mu|\) is essentially constant.
  If \(H_\mu\) is finite for almost all \(\mu\), by Lemma~\ref{lem:finite-zero}, \(H_\mu\) is empty for almost all \(\mu\). Hence Lemma~\ref{lem:H=0} and Lemma~\ref{lem:4.11} lead to our desired map.

  The only thing left to prove is that \(H_\mu\) cannot be infinite. Contrarily, assume that it is. For every \(\mu, \nu\) we consider the set \(H_\mu \cap H_\nu\). By Lemma~\ref{lem:hh-const} their cardinality must be essentially constant and we consider the case that the sets are infinite for almost all \(\mu, \nu \in \mathcal{P}(\bar X)\).
  We define the set
  \[
    \mathcal{E} \coloneqq \{(\mu, \nu) \in \mathcal{P}(\bar X) \times \mathcal{P}(\bar X)\mid H_\mu = H_\nu\}.
  \]
  If \(f\colon \mathcal{P}(\bar X) \to \operatorname{Pot}(\mathcal{H})\) is the map such that  \(\mu \mapsto H_\mu\), then \(\mathcal{E} = (f \times f)^{-1}(\Delta)\), where \(\Delta \subset \operatorname{Pot}(\mathcal{H})^2\) is the diagonal. The set \(\operatorname{Pot}(\mathcal{H})\) is Hausdorff with regard to the cylinder topology. Hence \(\Delta\) is closed and measurable. The map \(f \times f\) is also measurable and we obtain that the same is true for \(\mathcal{E}\). Furthermore, \(\mathcal{E}\) is \(\Gamma\)-invariant.  By the doubly ergodic action of \(\Gamma\) on \(\mathcal{P}(\bar X)\), it has either measure 0 or measure 1. Let us consider the two cases:
  \begin{description}
  \item[Case \(\vartheta(\mathcal{E})=1\):] Since \(H_\mu = H_\nu\) for almost all \(\mu\) and \(\nu\), by the definition of the product measure, we can find \(\mu_0 \in \mathcal{P}(\bar X)\) and a full measure subset \(M \subset \mathcal{P}(X)\) such that \(H_\nu = H_{\mu_0}\) for all \(\nu \in M\). By Lemma~\ref{lem:countable-orbit}, we find \(\nu \in M\) such that
    \[
      H_{g\nu} = gH_\nu = H_{g\nu} = H_{\mu_0} = H_\nu
    \]
    for every \(g \in \Gamma\). The set \(H_\nu\) is a pocset that is additionally closed under involution. By Lemma~\ref{lem:4.6}, we cann apply Proposition~\ref{prop:f-3.32}. Hence, either \(\mathcal{H} = H_\mu\) or \(X = X' \times X''\), where \(X'\) has \(H_\mu\) as its pocset of halfspaces. In both cases, the irreducible factors of \(X\) would contain an interval, since \(X(H_\mu)\) is an interval by Lemma~\ref{lem:interval}. However, by Corollary~\ref{cor:f-3.21}, this contradicts the fact that the \(\Gamma\)-action is non-elementary.
  \item[Case \(\vartheta(\mathcal{E})=0\):] In this case we have \(H_\mu \neq H_\nu\) for almost all \(\mu\) and \(\nu\). We decompose \(X\) into its irreducible factors
    \[
      X = X_1 \times \dots \times X_n
    \]
    and \(\mathcal{H}\) into the associated subsets of pairwise transverse halfspaces
    \[
      \mathcal{H} = \mathcal{H}_1 \sqcup \dots \sqcup H_n.
    \]
    Furthermore, we denote by \(\Gamma_0 \leq \Gamma\) the finite index subgroup respecting this decomposition. Then \(\Gamma_0\) acts still non-elementary and essential on \(X\). We define the set
    \[
      \mathcal{S}_i \coloneqq \{(\mathfrak{h}, \mathfrak{k}) \in \mathcal{H}_i \times \mathcal{H}_i \mid \mathfrak{h} \text{ and } \mathfrak{k} \text{ are strongly separated in } \mathcal{H}_i\}.
    \]
    By Lemma~\ref{lem:strongly-sep}, we see that this set is \(\Gamma_0\)-invariant and we can consider the following map
    \begin{align*}
      \mathcal{P}(\bar X) &\to \N \cup \{\infty\},\\
      \mu &\mapsto |(H_\mu \times H_\mu) \cap \mathcal{S}_i|,
    \end{align*}
    which is by the above observation \(\Gamma_0\)-invariant and also measurable (c.\,f.\ Lemma~\ref{lem:measurable-str-sep} together with Lemma~\ref{lem:proj-weight}). Hence, it is essentially constant (Lemma~\ref{lem:4.3}). We have two cases depending on the essential values \(N_i\).
    \begin{description}
    \item[Case 1:] The value \(N_i > 0\) for all \(i\), i.\,e.\ there are strongly separated hyperplanes in all \(H_\mu \cap \mathcal{H}_i\). Hence, we can use Lemma~\ref{lem:4.18} and see that \(H_\mu^+\) satisfies the descending chain condition. This implies that the sets \(H_\mu^+ \cap H_\nu\) contain terminal elements whenever the intersection is not empty. Furthermore, \(\tau([H_\mu^+ \cap H_\nu] \cup [H_\nu^+ \cap H_\mu])\) is finite by Lemma~\ref{lem:finite-terminal}. However, then
      \begin{align*}
        \mathcal{P}(\bar X) \times \mathcal{P}(\bar X) &\to \operatorname{Pot}_f(\mathcal{H}),\\
        (\mu,\nu) &\mapsto \tau([H_\mu^+ \cap H_\nu] \cup [H_\nu^+ \cap H_\mu])
      \end{align*}
      is \(\Gamma\)-equivariant and measurable (c.\,f.\ Lemma~\ref{lem:measurable-tau-int}) and Corollary~\ref{cor:4.5} assures \(H_\mu^+ \cap H_\nu = \varnothing\) for almost all \(\mu\) and \(\nu\). However, \(H_\nu \neq H_\mu\) for almost all \(\mu\) and \(\nu\). Hence, there exists \(\mathfrak{h} \in H_\nu \setminus H_\mu\) and thus \(\mathfrak{h} \in H_\mu^\pm\). Without loss of generality, we can assume that it lies in \(H_\mu^+\) and we see that \(H_\mu^+ \cap H_\nu \neq \varnothing\) for almost all \(\mu\) and \(\nu\), which is a contradiction.
    \item[Case 2:] The value \(N_i = 0\) for at least one \(i\). Without loss of generality, we can assume \(N_1 = 0\). The space \(X_1\) is irreducible, \(H_{p_{1\ast}\mu} = H_\mu \cap \mathcal{H}_1\) does not contain pairs of strongly separated halfspaces. Furthermore, \(H_{p_{1\ast}\mu} \cap H_{p_{1\ast}\nu} = \varnothing\) for almost all \(\mu, \nu\). Hence, we can apply Proposition~\ref{prop:4.21} and find a contradiction to the fact that \(\Gamma_0\) is both essential and non-elementary.
    \end{description}
  \end{description}
  Hence we see that \(H_\mu \cap H_\nu\) cannot be infinite. Thus, we have the map
  \begin{align*}
    \mathcal{P}(\bar X) \times \mathcal{P}(\bar X) & \to \operatorname{Pot}_f(\mathcal{H}),\\
    (\mu,\nu) &\mapsto H_\mu \cap H_\nu,
  \end{align*}
  which is \(\Gamma\)-invariant and measurable (c.\,f.~Section~\ref{sec:meas-maps}) and takes values in the finite subsets of \(\mathcal{H}\). With the help of Corollary~\ref{cor:4.5}, we see that this implies that \(H_\mu \cap H_\nu\) must be empty for almost all \(\mu\) and \(\nu\).

  In this case we consider the map
  \begin{align*}
    \mathcal{P}(\bar X) \times \mathcal{P}(\bar X) &\to \N \cup \{\infty\},\\
    (\mu, \nu) &\mapsto |\tau([H_\mu \cap H_\nu^+] \cup [H_\nu \cap H_\mu^+])|,
  \end{align*}
  where \(\tau\) is the map assigning the set of terminal elements to any subset of \(\mathcal{H}\) (c.\,f.~Definition~\ref{defin:tau}). This map is again measurable (c.\,f.\ Lemmas~\ref{lem:measurable-countable} and~\ref{lem:measurable-tau-int}) and \(\Gamma\)-invariant. Hence, it is essentially constant. Furthermore, by Lemma~\ref{lem:finite-terminal} the map takes only finite values. However, by Corollary~\ref{cor:4.5}, we have that \([H_\mu \cap H_\nu^+] \cup [H_\nu \cap H_\mu^+]\) contains no terminal elements for almost all \(\mu\) and \(\nu\). This allows us to apply Proposition~\ref{prop:4.10}, which leads to the impossibility of the case \(H_\mu \cap H_\nu = \varnothing\) and hence of \(|H_\mu| = \infty\). 
\end{proof}

Before finishing this treatise, we would like to drop the essentiality condition on \(\Gamma\). This is indeed possible. The only thing we lose is that we cannot be sure that the image lies in the non-terminating ultrafilters. However, it will still lie in \(\partial X\). The precise statement is as follows:

\begin{cor}
  \label{cor:4.2}
  Let \(\Gamma \to \Aut(X)\) be a discrete, countable group acting on a connected, locally countable, finite-dimensional CAT(0) cube complex \(X\). Assume that the action is non-elementary and denote by \(Y\) the essential core of \(X\). Then there exists a measurable map
  \[
    \phi \colon B \to \partial Y \subseteq \partial X
  \]
  which is \(\Gamma\)-equivariant almost everywhere.
\end{cor}

\begin{proof}
  Since there is no finite orbit of \(\Gamma\) in the visual boundary, we also have no fixed point there. Hence, we can apply Proposition~\ref{prop:cs-3.5}, which yields that the essential core \(Y\) is not empty. As a convex subcomplex, we have \(\partial_\sphericalangle Y \subset \partial_\sphericalangle X\) and we see that \(\Gamma\) acts non-elementary on \(Y\), too. By definition, the action \(\Gamma\) on \(Y\) is also essential. Hence, we can apply Theorem~\ref{thm:4.1} and find the map
  \[
    \phi\colon B \to \partial Y.
  \]
  With the help of Lemma~\ref{lem:roller-bnd-embedding}, we can embedd \(\partial Y\) into \(\partial X\) in a natural way that is compatible with the \(\Gamma\)-action.
\end{proof}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../Master"
%%% ispell-local-dictionary: "en_US"
%%% End:
